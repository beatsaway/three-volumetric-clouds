<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volumetric Clouds</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{overflow:hidden;font-family:Arial,sans-serif}
        canvas{display:block}
        #header{position:absolute;top:0;left:0;color:#fff;font-size:24px;z-index:1001;cursor:pointer;user-select:none;padding:12px 20px;background:transparent;display:flex;align-items:center;justify-content:flex-start}
        #backdrop{position:fixed;top:0;left:0;width:100vw;height:100vh;background:transparent;z-index:999;opacity:0;visibility:hidden;pointer-events:none;transition:opacity .3s,visibility .3s}
        #backdrop.visible{opacity:1;visibility:visible;pointer-events:auto}
        #controls{position:fixed;top:0;left:0;width:280px;max-width:85vw;height:100vh;background:rgba(20,20,25,0.95);padding:50px 16px 16px;color:#fff;overflow-y:auto;overflow-x:hidden;z-index:1000;transform:translateX(-100%);transition:transform .3s ease-out;display:flex;flex-direction:column;gap:12px;box-shadow:2px 0 10px rgba(0,0,0,0.3)}
        #controls.visible{transform:translateX(0)}
        #controls>div{width:100%;display:flex;align-items:center;gap:8px;min-width:0}
        #controls label{flex:0 0 50px;font-size:13px;white-space:nowrap}
        #controls input[type="range"]{flex:1;margin:0;min-width:0}
        #controls select{flex:1;padding:6px 8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.3);border-radius:5px;color:#fff;font-size:13px;cursor:pointer;min-width:0}
        #controls select option{background:#333;color:#fff}
        #controls [id$="Value"]{flex:0 0 45px;font-size:11px;color:#ffffff;text-align:right}
        @media (max-width:768px){
            #header{font-size:20px;padding:10px 15px}
            #controls{width:260px;padding:45px 12px 12px}
        }
        #coffeePopup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(20,20,25,0.98);padding:30px 40px;border-radius:12px;z-index:2000;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.4);max-width:400px;width:90%}
        #coffeePopup p{color:#fff;font-size:16px;margin-bottom:20px;line-height:1.5}
        #coffeePopup a{color:#fff;text-decoration:none;font-size:16px;display:inline-block}
        #coffeePopup .closeBtn{position:absolute;top:10px;right:15px;color:#fff;font-size:24px;cursor:pointer;line-height:1;background:none;border:none;padding:0;width:30px;height:30px}
        #coffeePopupOverlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);z-index:1999}
    </style>
</head>
<body>
    <div id="coffeePopupOverlay" style="display:none;"></div>
    <div id="coffeePopup" style="display:none;">
        <button class="closeBtn" onclick="document.getElementById('coffeePopup').style.display='none';document.getElementById('coffeePopupOverlay').style.display='none';">Ã—</button>
        <p>Buy me a coffee if you like this!</p>
        <a href="https://buymeacoffee.com/beatsaway" target="_blank" rel="noopener noreferrer">ðŸ¤—â˜•</a>
    </div>
    <div id="header">â˜°</div>
    <div id="backdrop"></div>
    <div id="controls">
        <div>
            <label>Speed</label>
            <input type="range" id="cloudSpeed" min="0" max="0.5" step="0.01" value="0.1">
            <div id="cloudSpeedValue">0.1</div>
        </div>
        <div>
            <label>Size</label>
            <input type="range" id="cloudScale" min="0.5" max="5" step="0.1" value="2.0">
            <div id="cloudScaleValue">2.0</div>
        </div>
        <div>
            <label>Light</label>
            <input type="range" id="lightBrightness" min="0" max="2" step="0.1" value="1.0">
            <div id="lightBrightnessValue">1.0</div>
        </div>
        <div>
            <label>Hue</label>
            <input type="range" id="hue" min="0" max="360" step="1" value="0">
            <div id="hueValue">0</div>
        </div>
        <div>
            <label>Camera</label>
            <select id="cameraView" style="flex:1;padding:6px 8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.3);border-radius:5px;color:#fff;font-size:13px;cursor:pointer;min-width:0">
            </select>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.167.1/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.167.1/examples/jsm/"
        }
    }
    </script>
    <script type="module">
        import { initVolumetricClouds } from './app.js';
        import { CameraViewsManager } from './camera-views.js';

        // Toggle controls panel
        const header = document.getElementById('header');
        const controls = document.getElementById('controls');
        const backdrop = document.getElementById('backdrop');
        
        function toggleControls() {
            const isVisible = controls.classList.contains('visible');
            controls.classList.toggle('visible');
            backdrop.classList.toggle('visible');
        }
        
        header.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleControls();
        });
        
        // Close panel when clicking backdrop
        backdrop.addEventListener('click', () => {
            controls.classList.remove('visible');
            backdrop.classList.remove('visible');
        });
        
        // Prevent controls click from closing panel
        controls.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Initialize clouds
        let cameraViewsManager = null;
        const cloudApp = initVolumetricClouds({
            onControlsReady: (cloudMaterial, cloudsRenderer) => {
                // Smooth interpolation for cloud parameters
                const smoothingFactor = 0.15; // Higher = faster transition (0-1)
                const maxSpeedChangePerFrame = 0.002; // Maximum speed change per frame to prevent erratic movement
                const targetValues = {
                    cloudSpeed: cloudMaterial.uniforms.uCloudSpeed.value,
                    cloudScale: cloudMaterial.uniforms.uCloudScale.value,
                    sceneBrightness: cloudsRenderer.renderMaterial.uniforms.uSceneBrightness.value
                };

                // Smooth update function - call this every frame
                function smoothUpdate(dt) {
                    // Smooth cloud speed with clamped change per frame
                    const speedDiff = targetValues.cloudSpeed - cloudMaterial.uniforms.uCloudSpeed.value;
                    if (Math.abs(speedDiff) > 0.001) {
                        // Calculate desired change
                        const desiredChange = speedDiff * smoothingFactor;
                        // Clamp to maximum change per frame
                        const clampedChange = Math.sign(desiredChange) * Math.min(Math.abs(desiredChange), maxSpeedChangePerFrame);
                        cloudMaterial.uniforms.uCloudSpeed.value += clampedChange;
                    } else {
                        cloudMaterial.uniforms.uCloudSpeed.value = targetValues.cloudSpeed;
                    }

                    // Smooth cloud scale
                    const scaleDiff = targetValues.cloudScale - cloudMaterial.uniforms.uCloudScale.value;
                    if (Math.abs(scaleDiff) > 0.001) {
                        cloudMaterial.uniforms.uCloudScale.value += scaleDiff * smoothingFactor;
                    } else {
                        cloudMaterial.uniforms.uCloudScale.value = targetValues.cloudScale;
                    }

                    // Smooth scene brightness
                    const brightnessDiff = targetValues.sceneBrightness - cloudsRenderer.renderMaterial.uniforms.uSceneBrightness.value;
                    if (Math.abs(brightnessDiff) > 0.001) {
                        cloudsRenderer.renderMaterial.uniforms.uSceneBrightness.value += brightnessDiff * smoothingFactor;
                    } else {
                        cloudsRenderer.renderMaterial.uniforms.uSceneBrightness.value = targetValues.sceneBrightness;
                    }
                }

                // Store smooth update function for animation loop
                window.cloudSmoothUpdate = smoothUpdate;

                function setupControls() {
                    // Speed (smooth interpolation with max 0.001 change per frame)
                    const cloudSpeed = document.getElementById('cloudSpeed');
                    const cloudSpeedValue = document.getElementById('cloudSpeedValue');
                    cloudSpeed.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        cloudSpeedValue.textContent = value.toFixed(2); // Update display immediately
                        targetValues.cloudSpeed = value; // Set target for smooth interpolation
                    });

                    // Size (Scale)
                    const cloudScale = document.getElementById('cloudScale');
                    const cloudScaleValue = document.getElementById('cloudScaleValue');
                    cloudScale.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        cloudScaleValue.textContent = value.toFixed(1); // Update display immediately
                        targetValues.cloudScale = value; // Set target for smooth interpolation
                    });

                    // Light (Scene Brightness)
                    const lightBrightness = document.getElementById('lightBrightness');
                    const lightBrightnessValue = document.getElementById('lightBrightnessValue');
                    lightBrightness.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        lightBrightnessValue.textContent = value.toFixed(1); // Update display immediately
                        targetValues.sceneBrightness = value; // Set target for smooth interpolation
                    });

                    // Hue adjustment
                    const baseColor = '#011029';
                    const hue = document.getElementById('hue');
                    const hueValue = document.getElementById('hueValue');
                    
                    function hexToHsl(hex) {
                        const r = parseInt(hex.slice(1, 3), 16) / 255;
                        const g = parseInt(hex.slice(3, 5), 16) / 255;
                        const b = parseInt(hex.slice(5, 7), 16) / 255;
                        const max = Math.max(r, g, b);
                        const min = Math.min(r, g, b);
                        let h, s, l = (max + min) / 2;
                        if (max === min) {
                            h = s = 0;
                        } else {
                            const d = max - min;
                            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                            switch (max) {
                                case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                                case g: h = ((b - r) / d + 2) / 6; break;
                                case b: h = ((r - g) / d + 4) / 6; break;
                            }
                        }
                        return [h * 360, s, l];
                    }
                    
                    function hslToHex(h, s, l) {
                        h = h % 360;
                        if (h < 0) h += 360;
                        const c = (1 - Math.abs(2 * l - 1)) * s;
                        const x = c * (1 - Math.abs((h / 60) % 2 - 1));
                        const m = l - c / 2;
                        let r, g, b;
                        if (h < 60) { r = c; g = x; b = 0; }
                        else if (h < 120) { r = x; g = c; b = 0; }
                        else if (h < 180) { r = 0; g = c; b = x; }
                        else if (h < 240) { r = 0; g = x; b = c; }
                        else if (h < 300) { r = x; g = 0; b = c; }
                        else { r = c; g = 0; b = x; }
                        r = Math.round((r + m) * 255);
                        g = Math.round((g + m) * 255);
                        b = Math.round((b + m) * 255);
                        return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
                    }
                    
                    const baseHsl = hexToHsl(baseColor);
                    
                    hue.addEventListener('input', (e) => {
                        const hueOffset = parseFloat(e.target.value);
                        hueValue.textContent = Math.round(hueOffset);
                        const adjustedHue = (baseHsl[0] + hueOffset) % 360;
                        const newColor = hslToHex(adjustedHue, baseHsl[1], baseHsl[2]);
                        cloudApp.updateBackgroundColor(newColor);
                    });
                }

                setupControls();
                
                // Initialize value displays
                document.getElementById('cloudSpeedValue').textContent = cloudMaterial.uniforms.uCloudSpeed.value.toFixed(2);
                document.getElementById('cloudScaleValue').textContent = cloudMaterial.uniforms.uCloudScale.value.toFixed(1);
                document.getElementById('lightBrightnessValue').textContent = cloudsRenderer.renderMaterial.uniforms.uSceneBrightness.value.toFixed(1);
                document.getElementById('hueValue').textContent = '0';
            },
            onAnimateUpdate: (dt) => {
                if (cameraViewsManager) {
                    cameraViewsManager.update();
                }
                // Smooth cloud parameter updates
                if (window.cloudSmoothUpdate) {
                    window.cloudSmoothUpdate(dt);
                }
            }
        });

        // Initialize camera views manager
        cameraViewsManager = new CameraViewsManager(cloudApp.camera, cloudApp.controls);
        
        // Save the default camera state as "View 0" if it doesn't exist
        if (!cameraViewsManager.views['View 0']) {
            cameraViewsManager.saveView('View 0');
        }
        
        // Setup camera view dropdown
        const cameraViewSelect = document.getElementById('cameraView');
        function populateCameraViews() {
            cameraViewSelect.innerHTML = '';
            const viewNames = cameraViewsManager.getViewNames();
            
            // Sort view names: "View 0" first, then "View 1", "View 2", etc.
            const sortedViewNames = viewNames.sort((a, b) => {
                // Extract numbers from view names
                const numA = parseInt(a.replace('View ', '')) || 0;
                const numB = parseInt(b.replace('View ', '')) || 0;
                return numA - numB;
            });
            
            sortedViewNames.forEach((name, index) => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (index === 0) {
                    option.selected = true;
                }
                cameraViewSelect.appendChild(option);
            });
        }
        
        populateCameraViews();
        
        cameraViewSelect.addEventListener('change', (e) => {
            const viewName = e.target.value;
            if (viewName) {
                cameraViewsManager.tweenToView(viewName);
            }
        });

        // Spacebar to switch to random camera view
        document.addEventListener('keypress', (e) => {
            if (e.key === ' ' || e.code === 'Space') {
                e.preventDefault();
                const viewNames = cameraViewsManager.getViewNames();
                if (viewNames.length > 0) {
                    const randomView = viewNames[Math.floor(Math.random() * viewNames.length)];
                    cameraViewsManager.tweenToView(randomView);
                    // Update dropdown to reflect the selected view
                    cameraViewSelect.value = randomView;
                }
            }
        });

        // Show coffee popup on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('coffeePopup').style.display = 'block';
                document.getElementById('coffeePopupOverlay').style.display = 'block';
            }, 1000);
        });

        // Close popup when clicking overlay
        document.getElementById('coffeePopupOverlay').addEventListener('click', () => {
            document.getElementById('coffeePopup').style.display = 'none';
            document.getElementById('coffeePopupOverlay').style.display = 'none';
        });

    </script>
</body>
</html>
